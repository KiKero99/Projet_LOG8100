stages:
  - security

security_scan:
  stage: security
  allow_failure: true # FIXME: remove this
  image:
    name: enriquitotupapi/webgoat:main
  services:
    - docker:dind
  script:
    # Pull the Docker image using the commit SHA
    - docker pull "$DOCKER_IMAGE_NAME:$CI_COMMIT_SHA"
    # Run Clair in combo mode
    - clair -mode combo
    # Generate a security report for the image and store it in clair-report.json
    - clairctl report "$DOCKER_IMAGE_NAME:$CI_COMMIT_SHA" --format json > clair-report.json
  artifacts:
    when: always
    expire_in: "1 week"
    paths:
      - clair-report.json
